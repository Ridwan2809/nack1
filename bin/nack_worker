#!/usr/bin/env ruby

require 'optparse'

options = {}

opts = OptionParser.new("", 24, '  ') { |opts|
  opts.banner = "Usage: nack_worker [options] [rackup config]"

  opts.on("-f", "--file SOCKET", "listen on SOCKET") { |file|
    options[:file] = File.expand_path(file)
  }

  opts.on("--pipe PIPE", "ready pipe") { |pipe|
    options[:pipe] = File.expand_path(pipe)
  }

  opts.on("-d", "--debug", "set debugging flags (set $DEBUG to true)") {
    $DEBUG = true
  }

  opts.parse! ARGV
}

config = ARGV[0] || "config.ru"

if !File.exist?(config)
  abort "configuration #{config} not found"
end

if !options[:file]
  abort "need a socket path"
end

begin
  require 'nack/builder'
  cfgfile = File.read(config)
  app = eval("Nack::Builder.new {( #{cfgfile}\n )}.to_app", nil, config)
rescue Exception => e
  if File.exist?(options[:file])
    File.unlink options[:file]
  end

  if options[:pipe] && File.pipe?(options[:pipe])
    require 'json'
    exception = {
      :name    => e.class,
      :message => e.message,
      :stack   => e.backtrace
    }

    a = open(options[:pipe], 'w')
    a.write exception.to_json
    a.close

    File.unlink options[:pipe]
  end

  exit 1
end

options[:name] = File.basename(File.dirname(config))

require 'nack/server'
Nack::Server.run(app, options)
