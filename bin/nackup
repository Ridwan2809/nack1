#!/usr/bin/env ruby

require 'nack'
require 'optparse'

options = {}

opts = OptionParser.new("", 24, '  ') { |opts|
  opts.banner = "Usage: nackup [options] [rackup config]"

  opts.on("-p", "--port PORT", "listen on PORT") { |port|
    options[:port] = port
  }

  opts.on("-f", "--file SOCKET", "listen on SOCKET") { |file|
    options[:file] = file
  }

  opts.on("-d", "--debug", "set debugging flags (set $DEBUG to true)") {
    $DEBUG = true
  }

  opts.parse! ARGV
}

config = ARGV[0] || "config.ru"

if !File.exist?(config)
  abort "configuration #{config} not found"
end

if !options[:port] && !options[:file]
  abort "need a port number or socket path"
end

cfgfile = File.read(config)
app = eval "Nack::Builder.new {( " + cfgfile + "\n )}.to_app",
                 nil, config

$stdout.sync = true
options[:onready] = proc { puts "ready" }

options[:name] = File.basename(File.dirname(config))

Nack::Server.run(app, options)
